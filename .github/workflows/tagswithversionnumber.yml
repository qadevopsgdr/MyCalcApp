name: Build and Push with Auto Tag

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.REGION }}

      # 3️⃣ Login to Amazon ECR
      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.REGION }} \
          | docker login --username AWS --password-stdin \
            ${{ secrets.ACCOUNT_ID }}.dkr.ecr.${{ secrets.REGION }}.amazonaws.com

      # 4️⃣ Determine next version tag
      - name: Determine next version tag
        id: get-tag
        run: |
          REPO_NAME="calc-gh"
          ACCOUNT_ID=${{ secrets.ACCOUNT_ID }}
          REGION=${{ secrets.REGION }}

          # Get latest tag (v1, v2, v3...)
          LAST_TAG=$(aws ecr list-images \
            --repository-name "$REPO_NAME" \
            --region "$REGION" \
            --query 'imageIds[?starts_with(imageTag, `v`)].imageTag' \
            --output text | tr '\t' '\n' | sort -V | tail -n 1)

          if [ -z "$LAST_TAG" ]; then
            NEW_TAG="v1"
          else
            NUM=$(echo "$LAST_TAG" | tr -d 'v')
            NEXT=$((NUM + 1))
            NEW_TAG="v${NEXT}"
          fi

          echo "Detected last tag: ${LAST_TAG:-none}"
          echo "Next tag: $NEW_TAG"
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV

      # 5️⃣ Build Docker image
      - name: Build Docker image
        run: |
          docker build -t calc-gh:$NEW_TAG .
          docker tag calc-gh:$NEW_TAG \
            ${{ secrets.ACCOUNT_ID }}.dkr.ecr.${{ secrets.REGION }}.amazonaws.com/calc-gh:$NEW_TAG
          docker tag calc-gh:$NEW_TAG \
            ${{ secrets.ACCOUNT_ID }}.dkr.ecr.${{ secrets.REGION }}.amazonaws.com/calc-gh:latest

      # 6️⃣ Push Docker image
      - name: Push Docker image
        run: |
          docker push ${{ secrets.ACCOUNT_ID }}.dkr.ecr.${{ secrets.REGION }}.amazonaws.com/calc-gh:$NEW_TAG
          docker push ${{ secrets.ACCOUNT_ID }}.dkr.ecr.${{ secrets.REGION }}.amazonaws.com/calc-gh:latest

      # 7️⃣ Show final result
      - name: Show pushed tags
        run: echo "✅ Successfully pushed tags:$NEW_TAG and latest"
